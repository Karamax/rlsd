#!/bin/sh

# pkg: installs or removes packages

case "$1" in
	install)
		echo "Installing $2"

		# download the package
		package="$(mktemp)"
		wget -O "$package" "ftp://dimakrasner.com/$2.pkg"
		if [ 0 -ne $? ]
		then
			echo "Error: failed to download $2."
			exit 1
		fi

		# decompress the package
		decompressed_package="$(mktemp)"
		mkdir "/var/pkg/$2"
		xzminidec < "$package" > "$decompressed_package"
		rm "$package"

		# register the package contents
		bsdtar -t -f "$decompressed_package" | \
		grep -v ^metadata > "/var/pkg/$2/contents"

		# extract the package
		bsdtar -x -m -f "$decompressed_package" -C /
		rm "$decompressed_package"

		# run the post-installation script
		[ -f /metadata/install.sh ] && /metadata/install.sh

		# move the post-removal script to /var/pkg
		[ -f /metadata/remove.sh ] && \
		                          mv /metadata/remove.sh "/var/pkg/$2/remove.sh"

		# remove /metadata
		rm -r /metadata
		;;

	remove)
		echo "Removing $2"

		# make sure the package is installed
		if [ ! -f "/var/pkg/$2/contents" ]
		then
			echo "Error: $1 is not installed."
			exit 1
		fi

		# remove the package files
		while read file
		do
			if [ -d "$file" ]
			then
				rmdir "/$file"
			else
				rm "/$file"
			fi
		done < "/var/pkg/$2/contents"

		# run the post-removal script
		[ -f "/var/pkg/$2/remove.sh" ] && "/var/pkg/$2/remove.sh"

		# remove the package metadata
		rm -r "/var/pkg/$2"
		;;

	*)
		exit 1
esac