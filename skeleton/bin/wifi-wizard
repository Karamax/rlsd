#!/bin/sh

# wifi-wizard: a wirless network configuration wizard

# let the user choose the interface
cd /sys/class/net
INTERFACE_DIALOG='<window title="Wireless Network Configuration">
	<vbox>
		<text><label>Choose a network interface:</label></text>
		<combobox>
			<variable>interface</variable>'

for i in *
do
	case "$i" in
		wlan*)
				INTERFACE_DIALOG="$INTERFACE_DIALOG <item>$i</item>"
				;;
	esac
done

export INTERFACE_DIALOG="$INTERFACE_DIALOG
		</combobox>
		<button ok></button>
	</vbox>
</window>"

eval $(gtkdialog1 --program=INTERFACE_DIALOG)

# if no interface was chosen, exit
[ -z "$interface" ] && exit 1

# disable the interface, to reset its counters
ifconfig $interface down

# bring up the interface again, to allow scanning
ifconfig $interface up

# let the user choose the wireless network
WIRELESS_DIALOG='<window title="Wireless Network Configuration">
<vbox>
	<text><label>Choose a wireless network:</label></text>
	<combobox>
		<variable>ssid</variable>'

for i in $(iw $interface scan | grep SSID: | awk '{print $2}')
do
	WIRELESS_DIALOG="$WIRELESS_DIALOG <item>$i</item>"
done

export WIRELESS_DIALOG="$WIRELESS_DIALOG
		</combobox>
		<hbox>
			<text><label>Passphrase:</label></text>
			<entry><variable>passphrase</variable></entry>
		</hbox>
		<button ok></button>
	</vbox>
</window>"

eval $(gtkdialog1 --program=WIRELESS_DIALOG)

# if no network was chosen, disable the interface and exit
if [ -z "$ssid" ]
then
	ifconfig $interface down
	exit 1
fi

# generate a wpa_supplicant configuration file
wpa_passphrase $ssid $passphrase > /etc/wpa_supplicant.conf

# stop dhcpcd
dhcpcd -k $interface

# stop wpa_supplicant
[ -f /run/wpa_supplicant.pid ] && kill $(cat /run/wpa_supplicant.pid)

# run wpa_supplicant
wpa_supplicant -B \
               -i$interface \
               -c/etc/wpa_supplicant.conf \
               -P/run/wpa_supplicant.pid

# run dhcpcd
dhcpcd -L $interface
